# Wire to Kessoku Migration Guide

Guide for migrating from google/wire to kessoku.

## Migration Command

```bash
# Migrate current directory
go tool kessoku migrate

# Migrate specific package
go tool kessoku migrate ./pkg/di

# Migrate with custom output file
go tool kessoku migrate -o providers.go

# Migrate multiple patterns
go tool kessoku migrate ./pkg/... -o kessoku.go
```

The command reads files with `//go:build wireinject` tag and generates kessoku configuration.

## Pattern Mappings

### Direct Mappings

| Wire | Kessoku |
|------|---------|
| `wire.NewSet(a, b, c)` | `kessoku.Set(a, b, c)` |
| `wire.Value(v)` | `kessoku.Value(v)` |
| Provider function `NewFoo` | `kessoku.Provide(NewFoo)` |
| Set variable reference | Preserved as-is |

### Bind Mapping

```go
// Wire
wire.Bind(new(Repository), new(*PostgresRepo))

// Kessoku
kessoku.Bind[Repository](kessoku.Provide(NewPostgresRepo))
```

**Note**: In kessoku, `Bind` wraps a provider, not just a type reference.

### InterfaceValue Mapping

```go
// Wire
wire.InterfaceValue(new(io.Writer), os.Stdout)

// Kessoku
kessoku.Bind[io.Writer](kessoku.Value(os.Stdout))
```

### Struct Mapping (Important!)

**Wire's `wire.Struct` does NOT map to `kessoku.Struct`**. They serve different purposes.

```go
// Wire - creates struct from injected fields
wire.Struct(new(Config), "DBHost", "DBPort")

// Kessoku (generated by migrate command)
kessoku.Provide(func(dBHost string, dBPort int) *Config {
    return &Config{
        DBHost: dBHost,
        DBPort: dBPort,
    }
})
```

The migrate command generates a constructor function.

### FieldsOf Mapping

```go
// Wire - extracts fields from struct
wire.FieldsOf(new(*Config), "DBHost", "DBPort")

// Kessoku (generated by migrate command)
kessoku.Provide(func(s *Config) (string, int) {
    return s.DBHost, s.DBPort
})
```

The migrate command generates an accessor function.

### Build (Injector) Mapping

```go
// Wire
//go:build wireinject

func InitializeApp() (*App, error) {
    wire.Build(
        NewConfig,
        NewDB,
        NewApp,
    )
    return nil, nil
}

// Kessoku
//go:generate go tool kessoku $GOFILE

var _ = kessoku.Inject[*App](
    "InitializeApp",
    kessoku.Provide(NewConfig),
    kessoku.Provide(NewDB),
    kessoku.Provide(NewApp),
)
```

## Complete Migration Example

### Before (wire.go)

```go
//go:build wireinject

package main

import "github.com/google/wire"

var DBSet = wire.NewSet(
    NewConfig,
    NewDB,
    wire.Bind(new(Repository), new(*PostgresDB)),
)

func InitializeApp() (*App, error) {
    wire.Build(
        DBSet,
        NewUserService,
        NewApp,
    )
    return nil, nil
}
```

### After (kessoku.go)

```go
//go:generate go tool kessoku $GOFILE

package main

import "github.com/mazrean/kessoku"

var DBSet = kessoku.Set(
    kessoku.Provide(NewConfig),
    kessoku.Bind[Repository](kessoku.Provide(NewDB)),
)

var _ = kessoku.Inject[*App](
    "InitializeApp",
    DBSet,
    kessoku.Provide(NewUserService),
    kessoku.Provide(NewApp),
)
```

## Post-Migration Steps

### 1. Remove Wire Files

After migration, delete the original wire files:

```bash
rm wire.go wire_gen.go
```

### 2. Add Async for Parallelization

The main benefit of kessoku is parallel initialization. After migration, identify slow providers and wrap them with `Async`:

```go
// Before (migrated, still sequential)
var _ = kessoku.Inject[*App](
    "InitializeApp",
    kessoku.Provide(NewDB),
    kessoku.Provide(NewCache),
    kessoku.Provide(NewApp),
)

// After (optimized with Async)
var _ = kessoku.Inject[*App](
    "InitializeApp",
    kessoku.Async(kessoku.Provide(NewDB)),    // Now parallel
    kessoku.Async(kessoku.Provide(NewCache)), // Now parallel
    kessoku.Provide(NewApp),
)
```

### 3. Regenerate

```bash
go generate ./...
```

## Key Differences from Wire

| Aspect | Wire | Kessoku |
|--------|------|---------|
| **Build tag** | `//go:build wireinject` | None needed |
| **Injector syntax** | Function returning `nil` | `var _ = kessoku.Inject[T](...)` |
| **Generated file** | `wire_gen.go` | `*_band.go` |
| **Execution** | Sequential | Parallel (with Async) |
| **Context support** | Manual | Automatic with Async |

## Troubleshooting Migration

### "No wire patterns found"

The source file needs `//go:build wireinject` tag for the migrate command to find it.

### Import Errors After Migration

Run `goimports` or add missing imports manually:

```bash
goimports -w kessoku.go
```

### Type Mismatch Errors

Wire allows some implicit conversions that kessoku doesn't. Check provider return types match expected dependencies.

### Missing Providers

Ensure all providers referenced in sets are included. The migrate command preserves set references but doesn't inline them.
